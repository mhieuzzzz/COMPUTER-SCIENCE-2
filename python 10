import tkinter as tk
from tkinter import ttk, messagebox
import serial
import serial.tools.list_ports
import threading
import json
import os
from datetime import datetime

class SmartParkingGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("HKN SMART PROJECT")
        self.root.geometry("900x700")
        self.root.configure(bg="#2C3E50")
        
        # Biáº¿n quáº£n lÃ½
        self.ser = None
        self.is_running = False
        self.registered_cards = self.load_registered_cards()
        
        # Äiá»u khiá»ƒn LED: 0=Táº®T, 1=Báº¬T, 2=NHáº¤P NHÃY
        self.led_state = 0
        
        # Táº¡o giao diá»‡n
        self.create_widgets()

    def toggle_led(self):
        """Báº­t/Táº¯t/Nháº¥p nhÃ¡y LED theo chu ká»³"""
        if self.ser:
            if self.led_state == 0:  # Äang Táº®T -> Báº­t
                self.ser.write(b"LED_ON\n")
                self.btn_led.config(text="ğŸ’¡ LED Báº¬T", bg="#F1C40F")
                self.add_log("ğŸ’¡ LED Báº¬T")
                self.led_state = 1
                
            elif self.led_state == 1:  # Äang Báº¬T -> Nháº¥p nhÃ¡y
                self.ser.write(b"LED_BLINK\n")
                self.btn_led.config(text="ğŸ’¡ LED NHáº¤P NHÃY", bg="#E67E22")
                self.add_log("ğŸ’¡ LED NHáº¤P NHÃY")
                self.led_state = 2
                
            else:  # Äang NHáº¤P NHÃY -> Táº¯t
                self.ser.write(b"LED_OFF\n")
                self.btn_led.config(text="ğŸ’¡ LED Táº®T", bg="#95A5A6")
                self.add_log("ğŸ’¡ LED Táº®T")
                self.led_state = 0
        else:
            messagebox.showwarning("Cáº£nh bÃ¡o", "ChÆ°a káº¿t ná»‘i Arduino!")
    
    def load_registered_cards(self):
        if os.path.exists("registered_cards.json"):
            try:
                with open("registered_cards.json", "r") as f:
                    return json.load(f)
            except:
                return {}
        return {}
    
    def save_registered_cards(self):
        with open("registered_cards.json", "w") as f:
            json.dump(self.registered_cards, f, indent=4)
    
    def create_widgets(self):
        # HEADER
        header_frame = tk.Frame(self.root, bg="#34495E", height=80)
        header_frame.pack(fill="x", padx=10, pady=10)
        header_frame.pack_propagate(False)
        
        title_label = tk.Label(header_frame, text="HNK SMART PROJECT", 
                              font=("Arial", 24, "bold"), bg="#34495E", fg="white")
        title_label.pack(pady=20)
        
        # Káº¾T Ná»I COM PORT
        connect_frame = tk.LabelFrame(self.root, text="Káº¿t ná»‘i Arduino", 
                                     font=("Arial", 12, "bold"), bg="#ECF0F1", fg="#2C3E50")
        connect_frame.pack(fill="x", padx=10, pady=5)
        
        port_frame = tk.Frame(connect_frame, bg="#ECF0F1")
        port_frame.pack(pady=10)
        
        tk.Label(port_frame, text="COM Port:", font=("Arial", 11), 
                bg="#ECF0F1").grid(row=0, column=0, padx=5)
        
        self.port_combo = ttk.Combobox(port_frame, width=15, state="readonly")
        self.port_combo.grid(row=0, column=1, padx=5)
        self.refresh_ports()
        
        tk.Button(port_frame, text="Refresh", command=self.refresh_ports,
                 bg="#3498DB", fg="white", font=("Arial", 10, "bold")).grid(row=0, column=2, padx=5)
        
        self.connect_btn = tk.Button(port_frame, text="Káº¿t ná»‘i", command=self.toggle_connection,
                                     bg="#27AE60", fg="white", font=("Arial", 11, "bold"), width=12)
        self.connect_btn.grid(row=0, column=3, padx=5)
        
        self.status_label = tk.Label(connect_frame, text="â— ChÆ°a káº¿t ná»‘i", 
                                    font=("Arial", 10), bg="#ECF0F1", fg="#E74C3C")
        self.status_label.pack(pady=5)
        
        # THÃ”NG TIN Há»† THá»NG
        info_container = tk.Frame(self.root, bg="#2C3E50")
        info_container.pack(fill="both", expand=True, padx=10, pady=5)
        
        left_frame = tk.LabelFrame(info_container, text="ThÃ´ng tin há»‡ thá»‘ng", 
                                  font=("Arial", 12, "bold"), bg="#ECF0F1", fg="#2C3E50")
        left_frame.pack(side="left", fill="both", expand=True, padx=(0, 5))
        
        # Nhiá»‡t Ä‘á»™
        temp_frame = tk.Frame(left_frame, bg="#ECF0F1")
        temp_frame.pack(pady=10)
        tk.Label(temp_frame, text="ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™:", font=("Arial", 12), 
                bg="#ECF0F1").pack(side="left", padx=5)
        self.temp_value = tk.Label(temp_frame, text="--Â°C", font=("Arial", 14, "bold"), 
                                   bg="#ECF0F1", fg="#E67E22")
        self.temp_value.pack(side="left")
        
        # Chá»— Ä‘á»— xe
        slot_frame = tk.Frame(left_frame, bg="#ECF0F1")
        slot_frame.pack(pady=10)
        tk.Label(slot_frame, text="ğŸ…¿ï¸ Chá»— trá»‘ng:", font=("Arial", 12), 
                bg="#ECF0F1").pack(side="left", padx=5)
        self.slot_value = tk.Label(slot_frame, text="0/3", font=("Arial", 14, "bold"), 
                                   bg="#ECF0F1", fg="#27AE60")
        self.slot_value.pack(side="left")
        
        # Card hiá»‡n táº¡i
        card_frame = tk.Frame(left_frame, bg="#ECF0F1")
        card_frame.pack(pady=10)
        tk.Label(card_frame, text="ğŸ’³ Card ID:", font=("Arial", 12), 
                bg="#ECF0F1").pack(anchor="w", padx=10)
        self.card_value = tk.Label(card_frame, text="ChÆ°a quÃ©t tháº»", font=("Arial", 11), 
                                   bg="#ECF0F1", fg="#7F8C8D", wraplength=300)
        self.card_value.pack(anchor="w", padx=10, pady=5)
        
        # Tráº¡ng thÃ¡i tháº»
        self.card_status = tk.Label(left_frame, text="", font=("Arial", 11, "bold"), 
                                   bg="#ECF0F1", wraplength=300)
        self.card_status.pack(pady=10)
        
        # NÃšT ÄIá»€U KHIá»‚N
        control_frame = tk.LabelFrame(left_frame, text="Äiá»u khiá»ƒn thá»§ cÃ´ng", 
                                     font=("Arial", 11, "bold"), bg="#ECF0F1", fg="#2C3E50")
        control_frame.pack(fill="x", padx=10, pady=10)
        
        button_frame = tk.Frame(control_frame, bg="#ECF0F1")
        button_frame.pack(pady=10)
        
        self.btn_open_in = tk.Button(button_frame, text="ğŸšª Má»Ÿ cá»•ng VÃ€O", 
                                     command=self.manual_open_in,
                                     bg="#3498DB", fg="white", 
                                     font=("Arial", 11, "bold"), width=15, height=2)
        self.btn_open_in.grid(row=0, column=0, padx=5, pady=5)
        
        self.btn_open_out = tk.Button(button_frame, text="ğŸšª Má»Ÿ cá»•ng RA", 
                                      command=self.manual_open_out,
                                      bg="#E67E22", fg="white", 
                                      font=("Arial", 11, "bold"), width=15, height=2)
        self.btn_open_out.grid(row=0, column=1, padx=5, pady=5)

        # NÃºt Ä‘iá»u khiá»ƒn LED (Báº­t -> Nháº¥p nhÃ¡y -> Táº¯t)
        self.btn_led = tk.Button(button_frame, text="ğŸ’¡ LED Táº®T", 
                                 command=self.toggle_led,
                                 bg="#95A5A6", fg="white", 
                                 font=("Arial", 11, "bold"), width=32, height=2)
        self.btn_led.grid(row=1, column=0, columnspan=2, padx=5, pady=5)
        
        # Quáº£n lÃ½ tháº»
        right_frame = tk.LabelFrame(info_container, text="Quáº£n lÃ½ tháº» RFID", 
                                   font=("Arial", 12, "bold"), bg="#ECF0F1", fg="#2C3E50")
        right_frame.pack(side="right", fill="both", expand=True, padx=(5, 0))
        
        # ÄÄƒng kÃ½ tháº» má»›i
        register_frame = tk.Frame(right_frame, bg="#ECF0F1")
        register_frame.pack(pady=10, padx=10, fill="x")
        
        tk.Label(register_frame, text="TÃªn chá»§ tháº»:", font=("Arial", 10), 
                bg="#ECF0F1").pack(anchor="w")
        self.owner_entry = tk.Entry(register_frame, font=("Arial", 11), width=25)
        self.owner_entry.pack(pady=5, fill="x")
        
        tk.Label(register_frame, text="Card ID (tá»« quÃ©t tháº»):", font=("Arial", 10), 
                bg="#ECF0F1").pack(anchor="w", pady=(5, 0))
        self.register_card_entry = tk.Entry(register_frame, font=("Arial", 11), width=25)
        self.register_card_entry.pack(pady=5, fill="x")
        
        tk.Button(register_frame, text="ğŸ“ ÄÄƒng kÃ½ tháº»", command=self.register_card,
                 bg="#9B59B6", fg="white", font=("Arial", 10, "bold")).pack(pady=10)
        
        # Danh sÃ¡ch tháº» Ä‘Ã£ Ä‘Äƒng kÃ½
        tk.Label(right_frame, text="Danh sÃ¡ch tháº» Ä‘Ã£ Ä‘Äƒng kÃ½:", 
                font=("Arial", 10, "bold"), bg="#ECF0F1").pack(anchor="w", padx=10)
        
        list_frame = tk.Frame(right_frame, bg="#ECF0F1")
        list_frame.pack(fill="both", expand=True, padx=10, pady=5)
        
        scrollbar = tk.Scrollbar(list_frame)
        scrollbar.pack(side="right", fill="y")
        
        self.card_listbox = tk.Listbox(list_frame, font=("Courier", 9), 
                                       yscrollcommand=scrollbar.set, height=10)
        self.card_listbox.pack(fill="both", expand=True)
        scrollbar.config(command=self.card_listbox.yview)
        
        tk.Button(right_frame, text="ğŸ—‘ï¸ XÃ³a tháº» Ä‘Ã£ chá»n", command=self.delete_card,
                 bg="#E74C3C", fg="white", font=("Arial", 10, "bold")).pack(pady=5)
        
        self.update_card_list()
        
        # Pháº§n log
        log_frame = tk.LabelFrame(self.root, text="Nháº­t kÃ½ hoáº¡t Ä‘á»™ng", 
                                 font=("Arial", 12, "bold"), bg="#ECF0F1", fg="#2C3E50")
        log_frame.pack(fill="both", expand=True, padx=10, pady=10)
        
        log_scroll = tk.Scrollbar(log_frame)
        log_scroll.pack(side="right", fill="y")
        
        self.log_text = tk.Text(log_frame, height=8, font=("Courier", 9), 
                               yscrollcommand=log_scroll.set, bg="#FDFEFE")
        self.log_text.pack(fill="both", expand=True, padx=5, pady=5)
        log_scroll.config(command=self.log_text.yview)
        
        self.add_log("Há»‡ thá»‘ng khá»Ÿi Ä‘á»™ng thÃ nh cÃ´ng!")
    
    def manual_open_in(self):
        if self.ser:
            self.ser.write(b"OPEN_IN\n")
            self.add_log("ğŸšª Má»Ÿ cá»•ng VÃ€O (thá»§ cÃ´ng)")
        else:
            messagebox.showwarning("Cáº£nh bÃ¡o", "ChÆ°a káº¿t ná»‘i Arduino!")

    def manual_open_out(self):
        if self.ser:
            self.ser.write(b"OPEN_OUT\n")
            self.add_log("ğŸšª Má»Ÿ cá»•ng RA (thá»§ cÃ´ng)")
        else:
            messagebox.showwarning("Cáº£nh bÃ¡o", "ChÆ°a káº¿t ná»‘i Arduino!")

    def refresh_ports(self):
        ports = serial.tools.list_ports.comports()
        port_list = [port.device for port in ports]
        self.port_combo['values'] = port_list
        if port_list:
            self.port_combo.current(0)
    
    def toggle_connection(self):
        if not self.is_running:
            try:
                port = self.port_combo.get()
                if not port:
                    messagebox.showerror("Lá»—i", "Vui lÃ²ng chá»n COM port!")
                    return
                
                self.ser = serial.Serial(port, 9600, timeout=1)
                self.is_running = True
                self.connect_btn.config(text="Ngáº¯t káº¿t ná»‘i", bg="#E74C3C")
                self.status_label.config(text=f"â— ÄÃ£ káº¿t ná»‘i: {port}", fg="#27AE60")
                self.add_log(f"ÄÃ£ káº¿t ná»‘i vá»›i {port}")
                
                self.read_thread = threading.Thread(target=self.read_serial, daemon=True)
                self.read_thread.start()
                
            except Exception as e:
                messagebox.showerror("Lá»—i káº¿t ná»‘i", f"KhÃ´ng thá»ƒ káº¿t ná»‘i: {str(e)}")
        else:
            self.is_running = False
            if self.ser:
                self.ser.close()
            self.connect_btn.config(text="Káº¿t ná»‘i", bg="#27AE60")
            self.status_label.config(text="â— ChÆ°a káº¿t ná»‘i", fg="#E74C3C")
            self.add_log("ÄÃ£ ngáº¯t káº¿t ná»‘i")
    
    def read_serial(self):
        while self.is_running:
            try:
                if self.ser and self.ser.in_waiting > 0:
                    line = self.ser.readline().decode('utf-8', errors='ignore').strip()
                    self.process_data(line)
            except Exception as e:
                self.add_log(f"Lá»—i Ä‘á»c dá»¯ liá»‡u: {str(e)}")
                break
    
    def process_data(self, data):
        if "DS18B20 Temp:" in data:
            parts = data.split("|")
            if len(parts) >= 2:
                temp = parts[0].split(":")[1].strip().replace("C", "")
                slots = parts[1].split(":")[1].strip()
                self.temp_value.config(text=f"{temp}Â°C")
                self.slot_value.config(text=slots)
        
        elif "Card UID:" in data:
            card_uid = data.replace("Card UID:", "").strip().upper()
            self.card_value.config(text=card_uid, fg="#2980B9")
            self.register_card_entry.delete(0, tk.END)
            self.register_card_entry.insert(0, card_uid)
            
            if card_uid in self.registered_cards:
                owner = self.registered_cards[card_uid]["owner"]
                self.card_status.config(text=f"âœ… Tháº» há»£p lá»‡ - {owner}", fg="#27AE60")
                self.add_log(f"âœ… Tháº» há»£p lá»‡: {owner} ({card_uid})")
                if self.ser:
                    self.ser.write(b"VALID\n")
            else:
                self.card_status.config(text="âŒ Tháº» chÆ°a Ä‘Äƒng kÃ½!", fg="#E74C3C")
                self.add_log(f"âŒ Tháº» chÆ°a Ä‘Äƒng kÃ½: {card_uid}")
                if self.ser:
                    self.ser.write(b"INVALID\n")
    
    def register_card(self):
        owner = self.owner_entry.get().strip()
        card_id = self.register_card_entry.get().strip().upper()
        
        if not owner or not card_id:
            messagebox.showwarning("Cáº£nh bÃ¡o", "Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin!")
            return
        
        if card_id in self.registered_cards:
            messagebox.showwarning("Cáº£nh bÃ¡o", "Tháº» nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½!")
            return
        
        self.registered_cards[card_id] = {
            "owner": owner,
            "registered_date": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        self.save_registered_cards()
        self.update_card_list()
        
        self.owner_entry.delete(0, tk.END)
        self.register_card_entry.delete(0, tk.END)
        
        self.add_log(f"ğŸ“ ÄÄƒng kÃ½ thÃ nh cÃ´ng: {owner} - {card_id}")
        messagebox.showinfo("ThÃ nh cÃ´ng", f"ÄÃ£ Ä‘Äƒng kÃ½ tháº» cho {owner}!")
    
    def delete_card(self):
        selection = self.card_listbox.curselection()
        if not selection:
            messagebox.showwarning("Cáº£nh bÃ¡o", "Vui lÃ²ng chá»n tháº» cáº§n xÃ³a!")
            return
        
        selected = self.card_listbox.get(selection[0])
        card_id = selected.split("-")[0].strip()
        
        if messagebox.askyesno("XÃ¡c nháº­n", f"Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a tháº» {card_id}?"):
            if card_id in self.registered_cards:
                del self.registered_cards[card_id]
                self.save_registered_cards()
                self.update_card_list()
                self.add_log(f"ğŸ—‘ï¸ ÄÃ£ xÃ³a tháº»: {card_id}")
    
    def update_card_list(self):
        self.card_listbox.delete(0, tk.END)
        for card_id, info in self.registered_cards.items():
            self.card_listbox.insert(tk.END, f"{card_id} - {info['owner']}")
    
    def add_log(self, message):
        timestamp = datetime.now().strftime("%H:%M:%S")
        self.log_text.insert(tk.END, f"[{timestamp}] {message}\n")
        self.log_text.see(tk.END)

if __name__ == "__main__":
    root = tk.Tk()
    app = SmartParkingGUI(root)
    root.mainloop()
